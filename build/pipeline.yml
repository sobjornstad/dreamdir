trigger:
- master

variables:
  tapFile: "$(Build.SourcesDirectory)/tap.out"

jobs:
  - job: Linux
    pool:
      vmImage: ubuntu-16.04
    steps:
      - bash: |
          # install BATS
          sudo apt-get install bats

          # install shellcheck
          export scversion="v0.5.0"
          wget -qO- "https://storage.googleapis.com/shellcheck/shellcheck-"${scversion}".linux.x86_64.tar.xz" | tar -xJv

          # install TAP to JUnit converter for test results
          sudo apt-get install cpanminus
          sudo cpanm install XML::Generator
          git clone https://github.com/jmason/tap-to-junit-xml.git tapjunit

          # set environment variables
          # Our shellcheck comes before system shellcheck
          # (as they already have one on the MS image that's a painfully old version).
          echo "##vso[task.setvariable variable=PATH]$PWD/shellcheck-"${scversion}":$PATH:$PWD/tapjunit:$PWD/drwc:."
        displayName: 'Set up testing environment'
      - template: test-steps.yml
      - bash: |
          tap-to-junit-xml <$(tapfile)
      - task: PublishTestResults@2
        inputs:
          testResultsFiles: $(tapfile)
          testResultsFormat: JUnit
          #searchFolder: '$(System.DefaultWorkingDirectory)' # Optional
          #mergeTestResults: false # Optional
          #failTaskOnFailedTests: false # Optional
          #testRunTitle: # Optional
          #buildPlatform: # Optional
          #buildConfiguration: # Optional
          publishRunAttachments: true